machine:
  services:
    - docker
  post:
    # circle instance already run postgresql
    - sudo service postgresql stop

dependencies:

  cache_directories:
    - "~/docker"

  override:
    - docker info
    - if [[ -e ~/docker/scrumble-api.tar ]]; then docker load -i ~/docker/scrumble-api.tar; fi
    - docker build -t nicgirault/scrumble-api api
    - mkdir -p ~/docker; docker save nicgirault/scrumble-api > ~/docker/scrumble-api.tar
    - docker-compose --file docker-compose.build.yml up appbuilder
    - if [[ -e ~/docker/scrumble.tar ]]; then docker load -i ~/docker/scrumble.tar; fi
    - docker build -t nicgirault/scrumble client
    - mkdir -p ~/docker; docker save nicgirault/scrumble > ~/docker/scrumble.tar

test:
  override:
    - docker-compose -f docker-compose.circle.yml run --rm apitest
    - docker-compose -f docker-compose.circle.yml run --rm apptest
